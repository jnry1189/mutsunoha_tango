<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãã ã¦ã‚‹ãŸã‚“ã”</title>
    <style>
        :root {
            --color-correct: #6aaa64;
            --color-present: #c9b458;
            --color-absent: #787c7e;
            --color-border: #d3d6da;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'MS PGothic', 'MS Gothic', 'Meiryo', sans-serif;
            background: #efefef;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
            color: #000;
        }
        
        .container {
            max-width: 600px;
            width: 100%;
            background: #fff;
            border: 1px solid #ccc;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            border-bottom: 1px solid #d3d6da;
        }
        
        h1 {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .slot-info {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .wait-screen {
            text-align: center;
            padding: 40px;
        }
        
        .wait-screen h2 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .countdown {
            font-size: 48px;
            font-weight: bold;
            color: var(--color-correct);
            margin: 20px 0;
        }
        
        .your-result {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .result-tiles {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 15px 0;
        }
        
        .result-row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .result-tile {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            border-radius: 4px;
        }
        
        .board {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .row {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .tile {
            width: 50px;
            height: 50px;
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }
        
        .tile.filled {
            border-color: #888;
        }
        
        .tile.correct {
            background-color: var(--color-correct);
            border-color: var(--color-correct);
            color: white;
        }
        
        .tile.present {
            background-color: var(--color-present);
            border-color: var(--color-present);
            color: white;
        }
        
        .tile.absent {
            background-color: var(--color-absent);
            border-color: var(--color-absent);
            color: white;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        #guessInput {
            font-size: 18px;
            padding: 10px;
            width: 200px;
            border: 2px solid var(--color-border);
            border-radius: 4px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        #submitBtn {
            background-color: #6aaa64;
            color: white;
        }
        
        #submitBtn:hover {
            background-color: #5a9a54;
        }
        
        #submitBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .secondary-btn:hover {
            background-color: #d0d0d0;
        }
        
        .message {
            text-align: center;
            margin-bottom: 20px;
            min-height: 30px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .message.success {
            color: var(--color-correct);
        }
        
        .message.error {
            color: #d32f2f;
        }
        
        .keyboard {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            margin-bottom: 20px;
        }
        
        .key {
            padding: 8px 4px;
            font-size: 12px;
            font-weight: bold;
            background-color: #d3d6da;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .key:hover {
            background-color: #c3c6ca;
        }
        
        .key.correct {
            background-color: var(--color-correct);
            color: white;
        }
        
        .key.present {
            background-color: var(--color-present);
            color: white;
        }
        
        .key.absent {
            background-color: var(--color-absent);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .modal h2 {
            margin-bottom: 20px;
        }
        
        .modal p {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .share-btn {
            display: block;
            margin: 20px auto;
            background-color: #1DA1F2;
            color: white;
            padding: 12px 30px;
        }
        
        .share-btn:hover {
            background-color: #1a8cd8;
        }
        
        .game-area {
            display: none;
        }
        
        .game-area.active {
            display: block;
        }
        
        .start-screen {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .start-screen.active {
            display: block;
        }
        
        .tree-area {
            margin: 30px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .cat-image {
            max-width: 80px;
            width: auto;
            height: auto;
            margin: 20px auto;
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .forest-image {
            max-width: 100%;
            width: auto;
            height: auto;
            margin: 20px auto;
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .result-message {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #000;
        }
        
        .rules {
            text-align: left;
            max-width: 400px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            border: 2px solid #d3d6da;
        }
        
        .rules li {
            margin: 10px 0;
            font-size: 14px;
        }
        
        .start-btn {
            display: inline-block;
            margin: 30px auto;
            padding: 15px 50px;
            font-size: 20px;
            background-color: var(--color-correct);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .start-btn:hover {
            background-color: #5a9a54;
        }
        
        .current-slot-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <pre style="font-family: 'MS PGothic', 'Mona', sans-serif; line-height: 1.1; font-size: 14px; margin: 0;">ï¼¿äººäººäººäººäººäººäººäººäººï¼¿
ï¼ã€€ãã ã¦ã‚‹ãŸã‚“ã”ã€€ï¼œ
ï¿£Y^Y^Y^Y^Y^Y^Y^Yï¿£</pre>
            <div class="slot-info" id="slotInfo">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="playerCount">-</div>
                    <div>æŒ‘æˆ¦è€…</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="correctRate">-</div>
                    <div>æ­£è§£ç‡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wordPoolSize">-</div>
                    <div>è¾æ›¸</div>
                </div>
            </div>
        </header>
        
        <div class="loading" id="loading">
            èª­ã¿è¾¼ã¿ä¸­...
        </div>
        
        <div class="start-screen" id="startScreen">
            <div class="tree-area">
                <p style="font-size: 18px; font-weight: bold; margin: 10px 0;">ç¾åœ¨ã®è¾æ›¸: <span id="startDictSize">-</span>èª</p>
            </div>
            
            <img id="startCatImage" class="cat-image" src="" alt="çŒ«">
            
            <div class="rules">
                <p style="font-weight: bold; margin-bottom: 15px;">ãƒ«ãƒ¼ãƒ«èª¬æ˜ã™ã‚‹ã«ã‚ƒï¼</p>
                <ul style="list-style: none; padding: 0;">
                    <li>ãƒ»5æ–‡å­—ã®æ—¥æœ¬èªã‚’å½“ã¦ã‚‹ã«ã‚ƒ</li>
                     <li>ãƒ»ç·‘è‰²ğŸŸ¢: æ–‡å­—ãŒæ­£è§£ã§ã‚ã‚Šã€å ´æ‰€ã‚‚åˆã£ã¦ã„ã‚‹ã€‚ã«ã‚ƒ</li>
                     <li>ãƒ»é»„è‰²ğŸŸ¡: æ–‡å­—ã¯æ­£è§£ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŒã€å ´æ‰€ãŒé•ã†ã€‚ã«ã‚ƒ</li>
                     <li>ãƒ»ç°è‰²ğŸ©¶: ç­”ãˆã®å˜èªã«å«ã¾ã‚Œã¦ã„ãªã„æ–‡å­—ã€‚ã«ã‚ƒ </li>

                    <li>ãƒ»è¾æ›¸ã«ãªã„å˜èªã¯ç™»éŒ²ã§ãã‚‹ã«ã‚ƒ</li>
                </ul>
                <p style="font-weight: bold; margin-top: 15px; color: var(--color-correct);">ã¿ã‚“ãªãŒãŸã‚“ã”ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ã“ã¨ã°ã®æœ¨ãŒãã ã¤ãƒ¢ãƒŠãƒ¼</p>
            </div>
            
            <button class="start-btn" id="startGameBtn">ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹</button>
            
            <div class="current-slot-info">
                <div>ç¾åœ¨ã®å‡ºé¡Œ: <span id="startSlotInfo">-</span></div>
                <div style="margin-top: 5px;">æŒ‘æˆ¦è€…: <span id="startPlayerCount">-</span>äººã€€æ­£è§£ç‡: <span id="startCorrectRate">-</span></div>
            </div>
        </div>
        
        <div class="wait-screen" id="waitScreen">
            <h2>æ¬¡ã®å‡ºé¡Œã¾ã§</h2>
            <div class="countdown" id="countdown">--:--:--</div>
            
            <div class="your-result" id="yourResult"></div>
            
            <img id="resultForestImage" class="forest-image" src="" alt="æ£®">
            <p class="result-message" id="resultMessage"></p>
            
            <button class="share-btn" id="shareBtn">çµæœã‚’ã‚·ã‚§ã‚¢</button>
        </div>
        
        <div class="game-area" id="gameArea">
            <div class="message" id="message"></div>
            
            <div class="board" id="board"></div>
            
            <div class="input-area">
                <input type="text" id="guessInput" maxlength="5" placeholder="5æ–‡å­—å…¥åŠ›">
                <button id="submitBtn">æ±ºå®š</button>
            </div>
            
            <div class="keyboard" id="keyboard"></div>
        </div>
    </div>
    
    <!-- å˜èªç™»éŒ²ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>è¾æ›¸ã«ãªã„å˜èªã§ã™</h2>
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button class="btn-primary" id="registerWordBtn">ç™»éŒ²ã™ã‚‹</button>
                <button class="secondary-btn" id="cancelRegisterBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, get, set, update, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCrJ-2vCD8Nt_14bwBq-gM-sX-rcZNerNw",
            authDomain: "mutsuki-570fe.firebaseapp.com",
            databaseURL: "https://mutsuki-570fe-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mutsuki-570fe",
            storageBucket: "mutsuki-570fe.firebasestorage.app",
            messagingSenderId: "836531971594",
            appId: "1:836531971594:web:3b040cca5a57e1b67421f3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
        const DEBUG = true;

        // 50éŸ³ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
        const KEYBOARD_CHARS = [
            'ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ', 'ã‹', 'ã', 'ã', 'ã‘', 'ã“',
            'ã•', 'ã—', 'ã™', 'ã›', 'ã', 'ãŸ', 'ã¡', 'ã¤', 'ã¦', 'ã¨',
            'ãª', 'ã«', 'ã¬', 'ã­', 'ã®', 'ã¯', 'ã²', 'ãµ', 'ã¸', 'ã»',
            'ã¾', 'ã¿', 'ã‚€', 'ã‚', 'ã‚‚', 'ã‚„', 'ã‚†', 'ã‚ˆ', 'ã‚‰', 'ã‚Š',
            'ã‚‹', 'ã‚Œ', 'ã‚', 'ã‚', 'ã‚’', 'ã‚“', 'ãŒ', 'ã', 'ã', 'ã’',
            'ã”', 'ã–', 'ã˜', 'ãš', 'ãœ', 'ã', 'ã ', 'ã¢', 'ã¥', 'ã§',
            'ã©', 'ã°', 'ã³', 'ã¶', 'ã¹', 'ã¼', 'ã±', 'ã´', 'ã·', 'ãº',
            'ã½', 'ã‚ƒ', 'ã‚…', 'ã‚‡', 'ã£'
        ];

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentSlot = '';
        let targetWord = '';
        let currentAttempt = 0;
        let maxAttempts = 7;
        let gameOver = false;
        let keyboardState = {};
        let pendingWord = '';
        let wordPool = {};
        let attempts = [];

        // DOMè¦ç´ 
        const loading = document.getElementById('loading');
        const startScreen = document.getElementById('startScreen');
        const waitScreen = document.getElementById('waitScreen');
        const gameArea = document.getElementById('gameArea');
        const slotInfo = document.getElementById('slotInfo');
        const playerCountEl = document.getElementById('playerCount');
        const correctRateEl = document.getElementById('correctRate');
        const wordPoolSizeEl = document.getElementById('wordPoolSize');
        const countdown = document.getElementById('countdown');
        const yourResult = document.getElementById('yourResult');
        const shareBtn = document.getElementById('shareBtn');
        const board = document.getElementById('board');
        const guessInput = document.getElementById('guessInput');
        const submitBtn = document.getElementById('submitBtn');
        const messageEl = document.getElementById('message');
        const keyboard = document.getElementById('keyboard');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const registerWordBtn = document.getElementById('registerWordBtn');
        const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢è¦ç´ 
        const startGameBtn = document.getElementById('startGameBtn');
        const startDictSize = document.getElementById('startDictSize');
        const startSlotInfo = document.getElementById('startSlotInfo');
        const startPlayerCount = document.getElementById('startPlayerCount');
        const startCorrectRate = document.getElementById('startCorrectRate');
        const startCatImage = document.getElementById('startCatImage');
        const resultForestImage = document.getElementById('resultForestImage');
        const resultMessage = document.getElementById('resultMessage');

        // ã‚¿ã‚¤ãƒ ã‚¹ãƒ­ãƒƒãƒˆè¨ˆç®—
        function getCurrentSlot() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = Math.floor(now.getHours() / 3) * 3;
            return `${year}-${month}-${day}-${String(hour).padStart(2, '0')}`;
        }

        // ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±è¡¨ç¤º
        function formatSlotInfo(slot) {
            const [year, month, day, hour] = slot.split('-');
            const startHour = parseInt(hour);
            const endHour = (startHour + 3) % 24;
            return `${year}/${month}/${day} ${String(startHour).padStart(2, '0')}:00 - ${String(endHour).padStart(2, '0')}:00`;
        }

        // æ¬¡ã®ã‚¹ãƒ­ãƒƒãƒˆã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
        function updateCountdown() {
            const now = new Date();
            const currentHour = now.getHours();
            const nextSlotHour = (Math.floor(currentHour / 3) + 1) * 3;
            const nextSlot = new Date(now);
            nextSlot.setHours(nextSlotHour, 0, 0, 0);
            
            if (nextSlotHour >= 24) {
                nextSlot.setDate(nextSlot.getDate() + 1);
                nextSlot.setHours(0, 0, 0, 0);
            }
            
            const diff = nextSlot - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            countdown.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ãƒ—ãƒ¬ã‚¤å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function canPlay() {
            const lastPlayedSlot = localStorage.getItem('lastPlayedSlot');
            return currentSlot !== lastPlayedSlot;
        }

        // ãƒ—ãƒ¬ã‚¤æ¸ˆã¿ãƒãƒ¼ã‚¯
        function markAsPlayed() {
            localStorage.setItem('lastPlayedSlot', currentSlot);
            const resultData = {
                attempts: attempts,
                success: gameOver && attempts[attempts.length - 1]?.word === targetWord,
                answer: targetWord
            };
            localStorage.setItem(`result_${currentSlot}`, JSON.stringify(resultData));
        }

        // å˜èªãƒ—ãƒ¼ãƒ«å–å¾—
        async function loadWordPool() {
            const snapshot = await get(ref(db, 'wordPool'));
            if (snapshot.exists()) {
                wordPool = snapshot.val();
                wordPoolSizeEl.textContent = Object.keys(wordPool).length;
            }
        }

        // ç¾åœ¨ã®å˜èªå–å¾—ã¾ãŸã¯é¸å®š
        async function getCurrentWord() {
            const wordRef = ref(db, `currentWords/${currentSlot}`);
            const snapshot = await get(wordRef);
            
            if (snapshot.exists()) {
                return snapshot.val().word;
            }
            
            // æ–°ã—ã„ã‚¹ãƒ­ãƒƒãƒˆãªã®ã§å˜èªã‚’é¸å®š
            const words = Object.keys(wordPool);
            
            // éå»10å›åˆ†ã®å˜èªã‚’å–å¾—
            const recentSlots = await getRecentSlots(10);
            const recentWords = [];
            for (const slot of recentSlots) {
                const slotSnapshot = await get(ref(db, `currentWords/${slot}`));
                if (slotSnapshot.exists()) {
                    recentWords.push(slotSnapshot.val().word);
                }
            }
            
            // æœ€è¿‘ä½¿ã‚ã‚Œã¦ã„ãªã„å˜èªã‹ã‚‰é¸ã¶
            const availableWords = words.filter(w => !recentWords.includes(w));
            const selectedWord = availableWords.length > 0 
                ? availableWords[Math.floor(Math.random() * availableWords.length)]
                : words[Math.floor(Math.random() * words.length)];
            
            // Firebaseã«ä¿å­˜
            await set(wordRef, {
                word: selectedWord,
                startTime: new Date().toISOString(),
                playerCount: 0,
                correctCount: 0
            });
            
            return selectedWord;
        }

        // éå»ã®ã‚¹ãƒ­ãƒƒãƒˆå–å¾—
        function getRecentSlots(count) {
            const slots = [];
            const now = new Date();
            for (let i = 1; i <= count; i++) {
                const slotTime = new Date(now.getTime() - (i * 3 * 60 * 60 * 1000));
                const year = slotTime.getFullYear();
                const month = String(slotTime.getMonth() + 1).padStart(2, '0');
                const day = String(slotTime.getDate()).padStart(2, '0');
                const hour = String(Math.floor(slotTime.getHours() / 3) * 3).padStart(2, '0');
                slots.push(`${year}-${month}-${day}-${hour}`);
            }
            return slots;
        }

        // çµ±è¨ˆæ›´æ–°
        async function updateStats() {
            const statsRef = ref(db, `currentWords/${currentSlot}`);
            const snapshot = await get(statsRef);
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                playerCountEl.textContent = data.playerCount || 0;
                const rate = data.playerCount > 0 
                    ? Math.round((data.correctCount || 0) / data.playerCount * 100)
                    : 0;
                correctRateEl.textContent = rate + '%';
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆç›£è¦–
        function watchStats() {
            const statsRef = ref(db, `currentWords/${currentSlot}`);
            onValue(statsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    playerCountEl.textContent = data.playerCount || 0;
                    const rate = data.playerCount > 0 
                        ? Math.round((data.correctCount || 0) / data.playerCount * 100)
                        : 0;
                    correctRateEl.textContent = rate + '%';
                }
            });
        }

        // ç›¤é¢ä½œæˆ
        function createBoard() {
            board.innerHTML = '';
            for (let i = 0; i < maxAttempts; i++) {
                const row = document.createElement('div');
                row.className = 'row';
                for (let j = 0; j < 5; j++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    row.appendChild(tile);
                }
                board.appendChild(row);
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ä½œæˆ
        function createKeyboard() {
            keyboard.innerHTML = '';
            KEYBOARD_CHARS.forEach(char => {
                const key = document.createElement('button');
                key.className = 'key';
                key.textContent = char;
                key.addEventListener('click', () => {
                    if (guessInput.value.length < 5 && !gameOver) {
                        guessInput.value += char;
                        guessInput.dispatchEvent(new Event('input'));
                    }
                });
                keyboard.appendChild(key);
                keyboardState[char] = '';
            });
        }

        // å…¥åŠ›å‡¦ç†
        function handleInput() {
            const val = guessInput.value;
            const row = board.children[currentAttempt];
            const tiles = row.querySelectorAll('.tile');
            
            for (let i = 0; i < 5; i++) {
                tiles[i].textContent = val[i] || '';
                if (val[i]) {
                    tiles[i].classList.add('filled');
                } else {
                    tiles[i].classList.remove('filled');
                }
            }
        }

        // æ±ºå®šãƒœã‚¿ãƒ³å‡¦ç†
        async function handleSubmit() {
            if (gameOver) return;
            
            const guess = guessInput.value;
            
            if (guess.length !== 5) {
                showMessage('5æ–‡å­—å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // è¾æ›¸ãƒã‚§ãƒƒã‚¯
            if (!wordPool[guess]) {
                pendingWord = guess;
                confirmMessage.textContent = `ã€Œ${guess}ã€ã¯è¾æ›¸ã«ã‚ã‚Šã¾ã›ã‚“ã€‚\nç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ¬¡å›ä»¥é™ã®å‡ºé¡Œã«ä½¿ã‚ã‚Œã¾ã™ï¼‰`;
                confirmModal.style.display = 'block';
                return;
            }
            
            processGuess(guess);
        }

        // æ¨æ¸¬å‡¦ç†
        async function processGuess(guess) {
            const result = evaluateGuess(guess, targetWord);
            const row = board.children[currentAttempt];
            const tiles = row.querySelectorAll('.tile');
            
            tiles.forEach((tile, i) => {
                tile.classList.add(result[i]);
            });
            
            updateKeyboard(guess, result);
            
            // è©¦è¡Œè¨˜éŒ²
            attempts.push({ word: guess, result: result });
            
            guessInput.value = '';
            const currentRow = board.children[currentAttempt];
            const currentTiles = currentRow.querySelectorAll('.tile');
            currentTiles.forEach(tile => tile.classList.remove('filled'));
            
            // å‹æ•—åˆ¤å®š
            if (toHiragana(guess) === toHiragana(targetWord)) {
                gameOver = true;
                showMessage('ğŸ‰ æ­£è§£ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼', 'success');
                
                // çµ±è¨ˆæ›´æ–°
                const statsRef = ref(db, `currentWords/${currentSlot}`);
                const snapshot = await get(statsRef);
                const data = snapshot.val();
                await update(statsRef, {
                    playerCount: (data.playerCount || 0) + 1,
                    correctCount: (data.correctCount || 0) + 1
                });
                
                markAsPlayed();
                
                setTimeout(() => {
                    showWaitScreen();
                }, 2000);
            } else {
                currentAttempt++;
                if (currentAttempt >= maxAttempts) {
                    gameOver = true;
                    showMessage(`ğŸ˜¢ æ®‹å¿µï¼æ­£è§£ã¯ã€Œ${targetWord}ã€ã§ã—ãŸ`, 'error');
                    
                    // çµ±è¨ˆæ›´æ–°ï¼ˆå¤±æ•—ï¼‰
                    const statsRef = ref(db, `currentWords/${currentSlot}`);
                    const snapshot = await get(statsRef);
                    const data = snapshot.val();
                    await update(statsRef, {
                        playerCount: (data.playerCount || 0) + 1
                    });
                    
                    markAsPlayed();
                    
                    setTimeout(() => {
                        showWaitScreen();
                    }, 2000);
                }
            }
        }

        // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
        function evaluateGuess(guess, answer) {
            // ã²ã‚‰ãŒãªã«çµ±ä¸€ã—ã¦åˆ¤å®š
            const normalizedGuess = toHiragana(guess);
            const normalizedAnswer = toHiragana(answer);
            
            const result = Array(5).fill('absent');
            const answerChars = normalizedAnswer.split('');
            const usedIndices = new Set();
            
            for (let i = 0; i < 5; i++) {
                if (normalizedGuess[i] === normalizedAnswer[i]) {
                    result[i] = 'correct';
                    usedIndices.add(i);
                }
            }
            
            for (let i = 0; i < 5; i++) {
                if (result[i] === 'correct') continue;
                
                for (let j = 0; j < 5; j++) {
                    if (!usedIndices.has(j) && normalizedGuess[i] === normalizedAnswer[j]) {
                        result[i] = 'present';
                        usedIndices.add(j);
                        break;
                    }
                }
            }
            
            return result;
        }

        // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠå¤‰æ›ãƒãƒƒãƒ—
        const hiraganaToKatakana = {
            'ã‚': 'ã‚¢', 'ã„': 'ã‚¤', 'ã†': 'ã‚¦', 'ãˆ': 'ã‚¨', 'ãŠ': 'ã‚ª',
            'ã‹': 'ã‚«', 'ã': 'ã‚­', 'ã': 'ã‚¯', 'ã‘': 'ã‚±', 'ã“': 'ã‚³',
            'ã•': 'ã‚µ', 'ã—': 'ã‚·', 'ã™': 'ã‚¹', 'ã›': 'ã‚»', 'ã': 'ã‚½',
            'ãŸ': 'ã‚¿', 'ã¡': 'ãƒ', 'ã¤': 'ãƒ„', 'ã¦': 'ãƒ†', 'ã¨': 'ãƒˆ',
            'ãª': 'ãƒŠ', 'ã«': 'ãƒ‹', 'ã¬': 'ãƒŒ', 'ã­': 'ãƒ', 'ã®': 'ãƒ',
            'ã¯': 'ãƒ', 'ã²': 'ãƒ’', 'ãµ': 'ãƒ•', 'ã¸': 'ãƒ˜', 'ã»': 'ãƒ›',
            'ã¾': 'ãƒ', 'ã¿': 'ãƒŸ', 'ã‚€': 'ãƒ ', 'ã‚': 'ãƒ¡', 'ã‚‚': 'ãƒ¢',
            'ã‚„': 'ãƒ¤', 'ã‚†': 'ãƒ¦', 'ã‚ˆ': 'ãƒ¨',
            'ã‚‰': 'ãƒ©', 'ã‚Š': 'ãƒª', 'ã‚‹': 'ãƒ«', 'ã‚Œ': 'ãƒ¬', 'ã‚': 'ãƒ­',
            'ã‚': 'ãƒ¯', 'ã‚’': 'ãƒ²', 'ã‚“': 'ãƒ³',
            'ãŒ': 'ã‚¬', 'ã': 'ã‚®', 'ã': 'ã‚°', 'ã’': 'ã‚²', 'ã”': 'ã‚´',
            'ã–': 'ã‚¶', 'ã˜': 'ã‚¸', 'ãš': 'ã‚º', 'ãœ': 'ã‚¼', 'ã': 'ã‚¾',
            'ã ': 'ãƒ€', 'ã¢': 'ãƒ‚', 'ã¥': 'ãƒ…', 'ã§': 'ãƒ‡', 'ã©': 'ãƒ‰',
            'ã°': 'ãƒ', 'ã³': 'ãƒ“', 'ã¶': 'ãƒ–', 'ã¹': 'ãƒ™', 'ã¼': 'ãƒœ',
            'ã±': 'ãƒ‘', 'ã´': 'ãƒ”', 'ã·': 'ãƒ—', 'ãº': 'ãƒš', 'ã½': 'ãƒ',
            'ã‚ƒ': 'ãƒ£', 'ã‚…': 'ãƒ¥', 'ã‚‡': 'ãƒ§', 'ã£': 'ãƒƒ',
            'ã‚¡': 'ã‚¡', 'ã‚£': 'ã‚£', 'ã‚¥': 'ã‚¥', 'ã‚§': 'ã‚§', 'ã‚©': 'ã‚©'
        };
        
        const katakanaToHiragana = {};
        Object.keys(hiraganaToKatakana).forEach(h => {
            const k = hiraganaToKatakana[h];
            katakanaToHiragana[k] = h;
        });

        // æ–‡å­—åˆ—ã‚’ã²ã‚‰ãŒãªã«çµ±ä¸€
        function toHiragana(str) {
            return str.split('').map(char => katakanaToHiragana[char] || char).join('');
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ã«çŒ«ç”»åƒã‚’é¸æŠ
        function getRandomCatImage() {
            const cats = ['cat1.png', 'cat2.png'];
            return cats[Math.floor(Math.random() * cats.length)];
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ã«æ£®ç”»åƒã‚’é¸æŠ
        function getRandomForestImage() {
            const forests = ['forest1.png', 'forest2.png'];
            return forests[Math.floor(Math.random() * forests.length)];
        }

        // çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        function getResultMessage(wordCount) {
            if (wordCount < 300) {
                return 'ã¾ã ã¾ã è‚²ã¦ã‚‹ã«ã‚ƒ';
            } else {
                return 'ç·‘ã®æƒ‘æ˜Ÿå¾©æ´»ã«ã‚ƒï¼';
            }
        }

        // æœ¨ã®æˆé•·æ®µéšã‚’å–å¾—ï¼ˆå‰Šé™¤äºˆå®šã ãŒä¸€æ—¦æ®‹ã™ï¼‰
        function getTreeStage(wordCount) {
            if (wordCount < 200) {
                return {
                    art: `ã€€ã€€ã€€âˆ§ï¼¿âˆ§
ã€€ã€€ï¼ˆã€€Â´ãƒ»Ï‰ãƒ»ï¼‰ç¨®ã‚’ã¾ã„ãŸã‚ˆ
ã€€ã€€ï¼ˆã€€ã€€ã¤â—ï¼¯
ã€€ã€€ã¨ï¼¿_)`,
                    message: 'ã¿ã‚“ãªã§ç¨®ã‚’ã¾ã„ãŸã‚ˆï¼'
                };
            } else if (wordCount < 500) {
                return {
                    art: `ã€€ã€€ã€€ã€€ã€€âˆ§
ã€€ã€€ã€€ã€€ï¼|ï¼¼
ã€€ã€€ã€€âˆ§ï¼¿âˆ§
ã€€ã€€ï¼ˆã€€Â´ãƒ»Ï‰ãƒ»ï¼‰èŠ½ãŒå‡ºãŸã‚ˆï¼
ã€€ã€€ï¼ˆã€€ã€€ã¤æ—¦ï¼¯
ã€€ã€€ã¨ï¼¿_)`,
                    message: 'ã¿ã‚“ãªã§èŠ½ã‚’è‚²ã¦ã¦ã‚‹ã‚ˆï¼'
                };
            } else if (wordCount < 1000) {
                return {
                    art: `ã€€ã€€ã€€ã€€ï¼¼|ï¼
ã€€ã€€ã€€â”€â”€â”¼â”€â”€
ã€€ã€€ã€€ã€€ï¼|ï¼¼
ã€€ã€€ã€€ã€€ã€€ï½œ
ã€€ã€€ã€€âˆ§ï¼¿âˆ§
ã€€ã€€ï¼ˆã€€Â´ãƒ»Ï‰ãƒ»ï¼‰æœ¨ãŒè‚²ã£ãŸã‚ˆï¼
ã€€ã€€ï¼ˆã€€ã€€ã¤æ—¦ï¼¯
ã€€ã€€ã¨ï¼¿_)`,
                    message: 'ã¿ã‚“ãªã§æœ¨ã‚’è‚²ã¦ã¦ã‚‹ã‚ˆï¼'
                };
            } else {
                return {
                    art: `ï½–ï½–ï½–ã€€ï½–ï½–ã€€ï½–ï½–ï½–ã€€ã€€ï½–ï½–ï½–ã€€ã€€ï½–ï½–ã€€ã€€ï½–ï½–
ã€€ï½–ï½–ï½–ã€€ã€€ã€€ï½–ï½–ï½–ã€€ã€€ï½–ï½–ã€€ã€€ã€€ï½–ï½–ã€€ï½–ï½–ï½–ã€€ã€€ï½–ï½–
ã€€ã€€ï½–ï½–ã€€ã€€ï½–ï½–ï½–ã€€ï½–ï½–ã€€ã€€ï½–ï½–ï½–ã€€ã€€ã€€ï½–ï½–ã€€ï½–ï½–ï½–
ã€€ã€€ã€€ï½–ï½–ã€€ã€€ã€€ï½–ï½–ã€€ã€€âˆ§ï¼¿âˆ§ã€€ã€€ï½–ï½–ã€€ã€€ã€€ï½–ï½–
ã€€ã€€ï½–ï½–ã€€ï½–ï½–ï½–ã€€ã€€ï¼ˆã€€Â´ãƒ»Ï‰ãƒ»ï¼‰ã€€ï½–ï½–ï½–ã€€ï½–ï½–
ã€€ï½–ï½–ã€€ã€€ã€€ï½–ï½–ã€€ï¼ˆã€€ã€€ã¤æ—¦ï¼¯ã€€ï½–ï½–ã€€ã€€ã€€ï½–ï½–ï½–
ã€€ã€€ï½–ï½–ï½–ã€€ã€€ï½–ï½–ã€€ã¨ï¼¿_)ã€€ã€€ï½–ï½–ã€€ã€€ï½–ï½–
ã€€ã€€ã€€ï½–ï½–ã€€ï½–ï½–ï½–ã€€ã€€ã€€ï½–ï½–ã€€ã€€ï½–ï½–ï½–ã€€ï½–ï½–`,
                    message: 'ã¿ã‚“ãªã®ãŠã‹ã’ã§æ£®ã«ãªã£ãŸã‚ˆï¼'
                };
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ›´æ–°ï¼ˆã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠä¸¡æ–¹å¡—ã‚‹ï¼‰
        function updateKeyboard(guess, result) {
            for (let i = 0; i < 5; i++) {
                const char = guess[i];
                const newState = result[i];
                
                // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã®ãƒšã‚¢ã‚’å–å¾—
                const hiragana = katakanaToHiragana[char] || char;
                const katakana = hiraganaToKatakana[char] || char;
                
                // ä¸¡æ–¹ã®æ–‡å­—ã‚’æ›´æ–°
                [hiragana, katakana].forEach(c => {
                    const currentState = keyboardState[c];
                    
                    if (currentState === 'correct') return;
                    if (currentState === 'present' && newState !== 'correct') return;
                    
                    keyboardState[c] = newState;
                    
                    const keys = keyboard.querySelectorAll('.key');
                    keys.forEach(key => {
                        if (key.textContent === c) {
                            key.className = 'key';
                            if (newState) key.classList.add(newState);
                        }
                    });
                });
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type = '') {
            messageEl.textContent = text;
            messageEl.className = 'message';
            if (type) messageEl.classList.add(type);
            
            if (type === 'error') {
                setTimeout(() => {
                    messageEl.textContent = '';
                    messageEl.className = 'message';
                }, 3000);
            }
        }

        // å˜èªç™»éŒ²
        async function registerWord() {
            const word = pendingWord;
            
            if (!wordPool[word]) {
                // Firebaseã«è¿½åŠ 
                const wordRef = ref(db, `wordPool/${word}`);
                await set(wordRef, {
                    source: 'player',
                    addedAt: new Date().toISOString()
                });
                
                wordPool[word] = {
                    source: 'player',
                    addedAt: new Date().toISOString()
                };
                
                wordPoolSizeEl.textContent = Object.keys(wordPool).length;
                
                showMessage(`ã€Œ${word}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`, 'success');
            }
            
            confirmModal.style.display = 'none';
            processGuess(pendingWord);
            pendingWord = '';
        }

        // ç™»éŒ²ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelRegister() {
            confirmModal.style.display = 'none';
            guessInput.value = '';
            
            const row = board.children[currentAttempt];
            const tiles = row.querySelectorAll('.tile');
            tiles.forEach(tile => {
                tile.textContent = '';
                tile.classList.remove('filled');
            });
            
            pendingWord = '';
        }

        // å¾…æ©Ÿç”»é¢è¡¨ç¤º
        function showWaitScreen() {
            gameArea.classList.remove('active');
            waitScreen.style.display = 'block';
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«æ£®ç”»åƒã‚’é¸æŠ
            resultForestImage.src = getRandomForestImage();
            
            // è¾æ›¸æ•°ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const wordCount = Object.keys(wordPool).length;
            resultMessage.textContent = getResultMessage(wordCount);
            
            // çµæœè¡¨ç¤º
            const resultData = JSON.parse(localStorage.getItem(`result_${currentSlot}`) || '{}');
            if (resultData.attempts && resultData.attempts.length > 0) {
                let html = '<h3>ã‚ãªãŸã®çµæœ</h3><div class="result-tiles">';
                resultData.attempts.forEach(att => {
                    html += '<div class="result-row">';
                    att.result.forEach(r => {
                        const emoji = r === 'correct' ? 'ğŸŸ©' : r === 'present' ? 'ğŸŸ¨' : 'â¬œ';
                        html += `<div class="result-tile">${emoji}</div>`;
                    });
                    html += '</div>';
                });
                html += '</div>';
                
                if (resultData.success) {
                    html += `<p style="font-size: 18px; font-weight: bold; color: var(--color-correct);">${resultData.attempts.length}å›ã§æ­£è§£ï¼</p>`;
                } else {
                    html += `<p style="font-size: 18px; font-weight: bold; color: #d32f2f;">å¤±æ•—</p>`;
                    if (resultData.answer) {
                        html += `<p style="font-size: 16px; margin-top: 10px;">æ­£è§£ã¯ã€Œ<strong>${resultData.answer}</strong>ã€ã§ã—ãŸ</p>`;
                    }
                }
                
                yourResult.innerHTML = html;
            }
            
            setInterval(updateCountdown, 1000);
            updateCountdown();
        }

        // ã‚·ã‚§ã‚¢æ©Ÿèƒ½
        function shareResult() {
            const resultData = JSON.parse(localStorage.getItem(`result_${currentSlot}`) || '{}');
            if (!resultData.attempts) return;
            
            let text = `ãã ã¦ã‚‹ãŸã‚“ã” ${formatSlotInfo(currentSlot)}\n\n`;
            resultData.attempts.forEach(att => {
                att.result.forEach(r => {
                    text += r === 'correct' ? 'ğŸŸ©' : r === 'present' ? 'ğŸŸ¨' : 'â¬œ';
                });
                text += '\n';
            });
            text += `\n${resultData.success ? `${resultData.attempts.length}å›ã§æ­£è§£ï¼` : 'å¤±æ•—'}\n`;
            text += '\nhttps://jnry1189.github.io/mutsunoha_tango/';
            
            if (navigator.share) {
                navigator.share({ text: text });
            } else {
                navigator.clipboard.writeText(text);
                alert('çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }
        }

        // åˆæœŸåŒ–
        async function init() {
            try {
                currentSlot = getCurrentSlot();
                slotInfo.textContent = formatSlotInfo(currentSlot);
                
                await loadWordPool();
                targetWord = await getCurrentWord();
                
                if (DEBUG) {
                    console.log('ç­”ãˆ:', targetWord);
                    console.log('ã‚¹ãƒ­ãƒƒãƒˆ:', currentSlot);
                }
                
                watchStats();
                await updateStats();
                
                loading.style.display = 'none';
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®çŒ«ç”»åƒã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
                startCatImage.src = getRandomCatImage();
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®çµ±è¨ˆæƒ…å ±æ›´æ–°
                const wordCount = Object.keys(wordPool).length;
                startDictSize.textContent = wordCount;
                startSlotInfo.textContent = formatSlotInfo(currentSlot);
                
                const statsRef = ref(db, `currentWords/${currentSlot}`);
                const snapshot = await get(statsRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    startPlayerCount.textContent = data.playerCount || 0;
                    const rate = data.playerCount > 0 
                        ? Math.round((data.correctCount || 0) / data.playerCount * 100)
                        : 0;
                    startCorrectRate.textContent = rate + '%';
                }
                
                if (canPlay()) {
                    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
                    startScreen.classList.add('active');
                    
                    // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³
                    startGameBtn.addEventListener('click', () => {
                        startScreen.classList.remove('active');
                        gameArea.classList.add('active');
                        createBoard();
                        createKeyboard();
                    });
                    
                    guessInput.addEventListener('input', handleInput);
                    submitBtn.addEventListener('click', handleSubmit);
                    guessInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleSubmit();
                    });
                } else {
                    // ãƒ—ãƒ¬ã‚¤æ¸ˆã¿ã®å ´åˆã‚‚ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
                    startScreen.classList.add('active');
                    
                    // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
                    startGameBtn.textContent = 'çµæœã‚’è¦‹ã‚‹';
                    
                    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å¾…æ©Ÿç”»é¢ã¸
                    startGameBtn.addEventListener('click', () => {
                        startScreen.classList.remove('active');
                        
                        // ãƒ—ãƒ¬ã‚¤æ¸ˆã¿ã®å ´åˆã€çµæœãƒ‡ãƒ¼ã‚¿ã«ç­”ãˆãŒãªã‘ã‚Œã°Firebaseã‹ã‚‰å–å¾—
                        const resultData = JSON.parse(localStorage.getItem(`result_${currentSlot}`) || '{}');
                        if (!resultData.answer && targetWord) {
                            resultData.answer = targetWord;
                            localStorage.setItem(`result_${currentSlot}`, JSON.stringify(resultData));
                        }
                        showWaitScreen();
                    });
                }
                
                registerWordBtn.addEventListener('click', registerWord);
                cancelRegisterBtn.addEventListener('click', cancelRegister);
                shareBtn.addEventListener('click', shareResult);
                
                window.onclick = function(event) {
                    if (event.target === confirmModal) {
                        cancelRegister();
                    }
                }
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                loading.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
            }
        }

        init();
    </script>
</body>
</html>
